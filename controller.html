<!doctype html>
<html>
  <head>
    <title>Touch Controller</title>
    <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  </head>

  <!-- CSS -->
  <link rel="stylesheet" type="text/css" href="../css/controller.css">

  <!-- JS -->
  <script src="/socket.io/socket.io.js"></script>
  <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
  <script src="../js/VectorTouchController.js"></script>
  <script src="js/vendor/jquery.touchglow.js"></script>
  <script src="js/vendor/howler.min.js"></script>

  <script>

    $(document).ready(function(){

      var socket = io();

      /**
     * Check for previously stored
     * data to determine whether
     * this is a first-time or
     * returning user.
     */
      var localData = localStorage.getItem('smm_player_data');

      if (localData !== null) {
        var data = JSON.parse(localData);
        promptReturnUser(data);
      } else {
        promptFirstTimer();
      }

      function promptReturnUser(data) {

        var nickname = prompt("Welcome back! (User:"+data.userid+")\nEnter nickname.", '');
        data.nickname = nickname;
        register(data);

      }

      function promptFirstTimer() {

        var nickname = prompt("Welcome! Touch and drag to move your character. Tap screen to mine asteroids. Enter nickname.", '');
        var data = {'nickname': nickname};
        register(data);

      }

      function register(data) {

        console.log('register: '+data);
        data.usertype = 'client_controller';
        data.usercolor = '#'+Math.floor(Math.random()*16777215).toString(16);
        socket.emit('register', data);

        setupTouchControls();

      }

      /**
     * Listen for instruction from
     * node to store new or updated
     * user data, specific to this
     * device. e.g., unique ids,
     * scores, customizations...
     */
      socket.on('store-local-data', function(data){

        if (typeof window.localStorage != "undefined") {

          localStorage.setItem(data.key, data.dataString);

        } else {

          console.log("WARNING: localstorage unavailable on this device");

        }

      });

      function setupTouchControls() {

        var touchControl = new VectorTouchController(socket);
        touchControl.enable();

        //Uncomment to simulate random user input.
        // touchControl.simulateUserInput();

      }

      //Experimental//device sound playback
      //because of mobile limitations, we must
      //instantiate our sounds on the first user event
      var sound;
      document.addEventListener( 'touchend', initSounds, false );
      function initSounds () {

        sound = new Howl({
            urls: ['sounds/sprite.mp3', 'sounds/sprite.ogg'],
            buffer: true,
            sprite: {
              stun: [0, 635],
              winner: [636, 4410]
            }
          });

        document.removeEventListener( 'touchend', initSounds, false );

      }

      socket.on('play-sound', function(data){
        console.log("play-snd", data.soundId);
        if (sound) {
          sound.play(data.soundId);
        }
      });

    });

  </script>

  <body>
    <br/><h3 id="instruct" style="pointer-events:none;">Touch and drag to move.<br/>Tap to mine.</h3>
    <canvas id="canvas"></canvas>
  </body>

</html>